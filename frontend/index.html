<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Electron application to import data to Salesforce with C# backend</title>
    <link rel="stylesheet" type="text/css" href="main.css">

    <script>
        const querystring = require('querystring');
        let query = querystring.parse(global.location.search);
        let data = JSON.parse(query['?data'])
        let styleFile;
        if (data.darkMode) {
            styleFile = "dark.css";
        } else {
            styleFile = "light.css";
        }
        var element = document.createElement("link");
        element.setAttribute("rel", "stylesheet");
        element.setAttribute("type", "text/css");
        element.setAttribute("href", styleFile);
        document.getElementsByTagName("head")[0].appendChild(element);
    </script>
</head>
<body>
    <div id="spinner" class="hide"></div>
    <div id="main-container">
        <div id="login-form-container">
            <div class="title">Login to Salesforce</div>
            <form id="login-form">
                <div><label>Username: <input id="username" name="username" required /></label></div>
                <div><label>Password: <input id="password" name="password" type="password" required /></label></div>
                <div><label>Client Id: <input id="client_id" name="client_id" required /></label></div>
                <div><label>Client Secret: <input id="client_secret" name="client_secret" type="password" required /></label></div>
                <div>
                    <label>
                        Login to:
                        <select id="login_url" name="org" required>
                            <option value="">--Select--</option>
                            <option value="https://test.login.salesforce.com">Sandbox</option>
                            <option value="https://login.salesforce.com" selected>Production</option>
                        </select>
                    </label>
                </div>
                <div><label>File: <input id="file_to_parse" type="file" name="file_to_parse" required /></label></div>
                <div><input type="button" value="Login" id="btn-login" /></div>
            </form>
        </div>
    </div>


    <div id="log">
        <textarea id="log-messages" readonly></textarea>

    </div>
    <script src="connection.js"></script>
    <script>
        //require('./connection.js')

        log("Welcome, let's rock together!");
        document.getElementById("btn-login").addEventListener("click", function() {

            let form = document.getElementById("login-form");
            if (form.checkValidity() === false) {

                for (var i = 0; i < form.elements.length; i++) {
                    input = form.elements[i];

                    if (input.checkValidity() === false) {
                        console.info(input.validationMessage);
                        input.classList.add('error');
                        //input.setCustomValidity(input.validationMessage);
                    }
                }

                //form has error do not send it
                return;
            }

            log("Login to salesforce...")

            spinnerOn();

            let username = document.getElementById("username").value;
            let password = document.getElementById("password").value;
            let client_id = document.getElementById("client_id").value;
            let client_secret = document.getElementById("client_secret").value;
            let login_url = document.getElementById("login_url").value;
            let file_to_parse = document.getElementById("file_to_parse").files[0].name;
            let data = [];

            data[0] = username;
            data[1] = password;
            data[2] = client_id;
            data[3] = client_secret;
            data[4] = login_url;
            data[5] = file_to_parse;

            //let username = document.getElementById("username").value;
            connection.send("login", JSON.stringify(data), (err, response) => {

                if (err) logError("Something very bad happen!", err);

                console.log(response);
                log(response);

                spinnerOff();

                log("Get salesforce objects");

                connection.send("getSFDCObjects", (err, response) => {

                    if (err) logError("Something very bad happen!", err);
                    let sfdcObjects = response;
                    //console.log(sfdcObjects);
                    log("List of objects retrieved...");

                    fs.readFile('frontend/list.html', (err, data) => {
                        document.getElementById('main-container').innerHTML = data
                        parseObjectsList(sfdcObjects);

                        document.getElementById("sfdc-objects-search-box").addEventListener("change", function() {
                            let value = this.value;

                            if (value.length > 0 && value.length < 3) {


                            } else if (value.length == 1) {
                                //reset all
                                search("--show-all");
                            } else {
                                //filter
                                search(value);
                            }
                        });

                        var fields = [];

                        document.getElementById("createMapping").addEventListener("click", function() {

                            log("Let's do the mapping");
                            spinnerOn();

                            connection.send("getHeaderRow", (err, header) => {

                                log("Get header row");
                                if (err) logError("Caramba, something is not ok", err);

                                form = document.getElementById("sfdc-objects");

                                for (var i = 0; i < form.elements.length; i++) {
                                    if (form.elements[i].checked) {
                                        fields.push(form.elements[i].value);
                                    }
                                }

                                header = JSON.parse(header);
                                console.log(header);

                                spinnerOff();

                                if (fields.length > 0) getMetadata(fields, header);
                            }); //get header
                        });

                        function getMetadata(fields, header) {

                            spinnerOn();
                            log("Get medatada");
                            var metadata;
                            connection.send("getMetadata", JSON.stringify(fields), (err, mapping) => {

                                if (err) logError("Good I am not Japanese ;)", err);

                                metadata = JSON.parse(mapping);
                                console.log(metadata);

                                addMapping(header, metadata);
                            }); // get metadata
                        }

                        function addMapping(header, metadata) {
                            fs.readFile('frontend/mapping.html', (err, data) => {

                                if (err) logError("Load mapping file error", err);

                                document.getElementById('main-container').innerHTML = data;

                                //display columns from CSV file
                                for (var i = 0; i < header.length; i++) {
                                    container = document.getElementById("file-objects-table");

                                    var row = document.createElement('tr');
                                    row.innerHTML = "<td class='cellSource'>" + header[i] + "</td><td class='cellTarget'>&nbsp;</td>";
                                    container.appendChild(row);
                                }

                                //display columns from metadata
                                container = document.getElementById("sfdc-objects-table");

                                var thead = document.createElement('thead');
                                var row = document.createElement('tr');
                                var rowInput = document.createElement('tr');

                                for (var i = 0; i < metadata.length; i++) {

                                    //thead.innerHTML = thead.innerHTML + "<th>" + metadata[i].Key + "</th>"
                                    th = document.createElement("th");
                                    td = document.createElement("td");
                                    th.innerHTML = "<th>" + metadata[i].Key + "</th>";
                                    td.innerHTML = "<td class='cellMetadata'><label><input type='checkbox' value='" + metadata[i].Key + "' class='checkboxParent' />Parent</label></td>";
                                    row.appendChild(th);
                                    rowInput.appendChild(td)
                                }

                                thead.appendChild(row);
                                container.appendChild(thead);
                                container.appendChild(rowInput);

                                document.querySelectorAll(".checkboxParent").forEach(function (element) {
                                    element.addEventListener("change", ParentSelected);
                                });                               
                            });

                            spinnerOff(); 
                        }
                    }) // read list html
                });

                //connection.close();
            });
        })
    </script>
</body>
</html>
